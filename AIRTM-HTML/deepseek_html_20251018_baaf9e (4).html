<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caja Diaria — Control Financiero (Dark)</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google API Client Library (v3) - Necesaria para interactuar con Drive -->
  <script src="https://apis.google.com/js/api.js" defer></script>
  <!-- Google Identity Services (GIS) - Necesaria para la autenticación OAuth2 -->
  <script src="https://accounts.google.com/gsi/client" defer></script>

  <style>
    :root {
      --bg: #0b1220; --panel: #111827; --accent: #047857; --danger: #b91c1c; --muted: #9ca3af; --glass: rgba(255,255,255,0.03);
      --card-radius: 14px; --pad: 14px; --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --transition: all 0.3s ease;
    }
    html, body { height: 100%; margin: 0; background: linear-gradient(180deg, #071022 0%, #071221 100%); font-family: var(--font); color: #e6eef6; transition: var(--transition); }
    .app { max-width: 1200px; margin: 28px auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; flex-wrap: wrap; }
    .card { background-color: var(--panel); border: 1px solid var(--glass); padding: var(--pad); border-radius: var(--card-radius); box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .input-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    input[type="number"], input[type="text"], input[type="date"], select {
      background-color: var(--bg); color: #e6eef6; border: 1px solid var(--glass); padding: 10px; border-radius: 8px; flex-grow: 1; transition: var(--transition);
    }
    input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(4, 120, 87, 0.5); }
    .btn { background-color: var(--accent); color: white; padding: 10px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; flex-shrink: 0; }
    .btn:hover { background-color: #069668; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(4, 120, 87, 0.4); }
    .btn-danger { background-color: var(--danger); }
    .btn-danger:hover { background-color: #da2929; }
    .btn-secondary { background-color: #374151; }
    .btn-secondary:hover { background-color: #4b5563; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 0.9em; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--glass); }
    th { background-color: var(--glass); font-weight: 600; color: var(--accent); text-transform: uppercase; }
    tr:last-child td { border-bottom: none; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .summary-card { background-color: var(--panel); border: 1px solid var(--accent); padding: var(--pad); border-radius: var(--card-radius); text-align: center; }
    .summary-title { font-size: 0.9em; color: var(--muted); margin-bottom: 5px; }
    .summary-value { font-size: 1.8em; font-weight: 700; color: #fff; }
    .text-success { color: #10b981; }
    .text-warning { color: #f59e0b; }
    .text-error { color: var(--danger); }
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .modal-backdrop.show { opacity: 1; visibility: visible; }
    .modal-content { background-color: var(--panel); border-radius: var(--card-radius); padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); transform: scale(0.95); transition: transform 0.3s ease; }
    .modal-backdrop.show .modal-content { transform: scale(1); }
    .filter-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }

    /* Estilos de la tabla de registros completos */
    #tablaCompleto { overflow-x: auto; }
    #tablaCompleto table { min-width: 800px; }
    .text-align-right { text-align: right; }
    .acciones-btn { margin-left: 5px; }

    /* Estilo para el input de tipo file oculto */
    #fileInput { display: none; }
  </style>

</head>
<body>
  <div class="app">
    <header>
      <h1 class="text-3xl font-bold">Caja Diaria <span class="text-accent">— Control Financiero</span></h1>
      <div class="flex gap-2">
        <button id="btnExport" class="btn btn-secondary">Exportar (JSON)</button>
        <button id="btnImport" class="btn btn-secondary">Importar (JSON)</button>
        <button id="btnSaveCloud" class="btn">Guardar en la Nube (Drive)</button>
      </div>
    </header>

    <!-- Modal para la nube (Drive) -->
    <div id="cloudModal" class="modal-backdrop" onclick="if(event.target.id === 'cloudModal') closeModal()">
        <div class="modal-content">
            <h2 id="cloudTitle" class="text-xl font-bold mb-4 text-center">Guardar en Google Drive</h2>
            <p id="cloudMessage" class="mb-6 text-center text-muted">Inicializando Google Drive...</p>
            
            <div id="driveControls" class="flex flex-col gap-3 hidden">
              <!-- Botón para Iniciar sesión / Autorizar (se muestra si no está logeado) -->
              <button id="btnAuthorizeDrive" class="btn hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                Conectar con Google Drive
              </button>
              
              <!-- Botón para Subir archivo (se muestra si está logeado) -->
              <button id="btnUploadDrive" class="btn hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13 13h3a3 3 0 000-6h-.025A5.56 5.56 0 0016 6.5 5.5 5.5 0 005.207 5.207l.793.793H13v4z" /><path d="M12 17.58L10 15.58l-2 2h4zm-5-3.14l-2 2h4zm10 0l-2 2h4z" /></svg>
                Subir y Actualizar Archivo
              </button>
              
              <!-- Botón para Descargar archivo (se muestra si está logeado) -->
              <button id="btnDownloadDrive" class="btn btn-secondary hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                Descargar (Sobreescribirá datos locales)
              </button>
            </div>

            <div class="flex justify-center mt-6">
                <button onclick="closeModal()" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>
    
    <div class="summary-grid" id="kpiContainer">
      <!-- KPIs se renderizarán aquí -->
    </div>

    <!-- Panel de Registro de Cierre Diario -->
    <div class="card">
      <h2 class="text-xl font-bold mb-4">1. Registro de Cierre Diario</h2>
      <div class="input-group">
        <label class="w-20 text-muted">Fecha:</label>
        <input type="date" id="inputFecha" value="" />
      </div>
      <div class="input-group">
        <label class="w-20 text-muted">Ventas:</label>
        <input type="number" id="inputVentas" placeholder="0.00" step="0.01" value="" />
      </div>
      <div class="input-group">
        <label class="w-20 text-muted">Gastos:</label>
        <input type="number" id="inputGastos" placeholder="0.00" step="0.01" value="" />
      </div>
      <div class="input-group">
        <label class="w-20 text-muted">Efectivo:</label>
        <input type="number" id="inputEfectivo" placeholder="0.00" step="0.01" value="" />
      </div>
      <div class="input-group">
        <label class="w-20 text-muted">Transferencia:</label>
        <input type="number" id="inputTransferencia" placeholder="0.00" step="0.01" value="" />
      </div>
      <div class="input-group">
        <label class="w-20 text-muted">Otros:</label>
        <input type="number" id="inputOtros" placeholder="0.00" step="0.01" value="" />
      </div>
      <div class="flex justify-end mt-4 gap-2">
        <button id="btnGuardar" class="btn">Guardar Cierre</button>
      </div>
    </div>

    <!-- Panel de Registro de Comisiones/Fees -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4">2. Registro de Comisiones/Fees (Opcional)</h2>
        <div class="input-group">
            <label class="w-20 text-muted">Monto Fee:</label>
            <input type="number" id="inputFeeMonto" placeholder="0.00" step="0.01" />
        </div>
        <div class="input-group">
            <label class="w-20 text-muted">Descripción:</label>
            <input type="text" id="inputFeeDescripcion" placeholder="Comisión TPV, retiro, etc." />
        </div>
        <div class="flex justify-end mt-4 gap-2">
            <button id="btnGuardarFee" class="btn">Agregar Fee</button>
            <button id="btnClearFees" class="btn btn-danger">Borrar Fees del Día</button>
        </div>
        <div id="tablaFeesContainer" class="mt-4">
          <h3 class="font-semibold mb-2">Fees Registrados Hoy: <span id="totalFeesHoy" class="text-warning">0.00</span></h3>
          <table id="tablaFees">
            <thead>
              <tr><th>Descripción</th><th class="text-align-right">Monto</th><th>Acción</th></tr>
            </thead>
            <tbody>
              <!-- Fees se renderizarán aquí -->
            </tbody>
          </table>
        </div>
    </div>

    <!-- Panel de Resumen Diario -->
    <div class="card">
      <h2 class="text-xl font-bold mb-4">3. Resumen de Cierres Diarios</h2>
      <div id="filterControls" class="filter-controls">
        <select id="filterDia" class="flex-1 min-w-[100px]"><option value="">Todos los Días</option></select>
        <select id="filterMes" class="flex-1 min-w-[100px]"><option value="">Todos los Meses</option></select>
        <select id="filterAnio" class="flex-1 min-w-[100px]"><option value="">Todos los Años</option></select>
        <button id="btnClearFilters" class="btn btn-secondary flex-shrink-0">Limpiar Filtros</button>
      </div>
      <div id="tablaCompleto" class="mt-4">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="text-align-right">Ventas</th>
              <th class="text-align-right">Gastos</th>
              <th class="text-align-right">Efectivo</th>
              <th class="text-align-right">Transferencia</th>
              <th class="text-align-right">Otros</th>
              <th class="text-align-right">Fees</th>
              <th class="text-align-right">Ganancia Neta</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="registrosCompletosBody">
            <!-- Registros se renderizarán aquí -->
          </tbody>
        </table>
      </div>
      
      <div class="flex justify-between mt-4">
        <button id="btnClear" class="btn btn-danger">Borrar TODOS los Registros</button>
      </div>
    </div>

    <!-- Input para Importar (oculto) -->
    <input type="file" id="fileInput" accept="application/json">
  </div>

  <script>
    // --- VARIABLES GLOBALES ---
    let data = {
      registros: [],
      fees: {}, // { 'YYYY-MM-DD': [{monto: 10, desc: '...'}, ...] }
    };

    const DB_KEY = 'cajaDiariaDB';
    // ATENCIÓN: Debes reemplazar este valor con tu CLIENT ID real de Google Cloud.
    // La integración de Google Drive no funcionará sin un CLIENT_ID válido y configurado.
    const CLIENT_ID = '165890661504-v2uvkpc12s7g3u1bf6gd358gieb031au.apps.googleusercontent.com'; 
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // Estados de inicialización de Google
    let gapiInitialized = false; // gapi.client.init ha sido llamado
    let gisReady = false;      // google.accounts.oauth2.initTokenClient ha sido llamado
    let googleServicesReady = false; // Flag para controlar la inicialización completa
    let tokenClient = null;
    let driveUploadInProgress = false;
    let driveTimeout = null;

    // --- UTILITIES ---
    const $ = (id) => document.getElementById(id);

    function formatCurrency(number) {
      if (typeof number !== 'number') return '0.00';
      return number.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function todayKey() {
      return new Date().toISOString().substring(0, 10);
    }

    // --- LOCAL STORAGE (PERSISTENCE) ---
    function saveLocal() {
      try {
        localStorage.setItem(DB_KEY, JSON.stringify(data));
      } catch (e) {
        console.error("Error saving to Local Storage:", e);
      }
    }

    function loadLocal() {
      try {
        const stored = localStorage.getItem(DB_KEY);
        if (stored) {
          data = JSON.parse(stored);
          // Asegurar que fees sea un objeto
          if (typeof data.fees !== 'object' || data.fees === null) {
            data.fees = {};
          }
        }
      } catch (e) {
        console.error("Error loading from Local Storage:", e);
      }
    }

    // --- DATA MANIPULATION ---
    function getRegistro(fecha) {
      return data.registros.find(r => r.fecha === fecha);
    }

    function getFees(fecha) {
      return data.fees[fecha] || [];
    }

    function getTotalFees(fecha) {
      return getFees(fecha).reduce((sum, fee) => sum + fee.monto, 0);
    }

    function calculateNetProfit(registro, totalFees) {
      if (!registro) return 0;
      // Ingresos es la suma de efectivo + transferencia + otros
      const ingresos = registro.efectivo + registro.transferencia + registro.otros;
      // Egresos es la suma de gastos + fees
      const egresos = registro.gastos + totalFees;
      return ingresos - egresos;
    }

    function clearInputs() {
      $('inputVentas').value = '';
      $('inputGastos').value = '';
      $('inputEfectivo').value = '';
      $('inputTransferencia').value = '';
      $('inputOtros').value = '';
      $('inputFecha').value = todayKey();
    }

    function guardarCierreDiario() {
      const fecha = $('inputFecha').value || todayKey();
      const ventas = parseFloat($('inputVentas').value) || 0;
      const gastos = parseFloat($('inputGastos').value) || 0;
      const efectivo = parseFloat($('inputEfectivo').value) || 0;
      const transferencia = parseFloat($('inputTransferencia').value) || 0;
      const otros = parseFloat($('inputOtros').value) || 0;

      if (ventas + gastos + efectivo + transferencia + otros === 0) {
        showMessage('No hay datos para guardar. Ingresa al menos una cifra.', 'warning');
        return;
      }

      let registro = getRegistro(fecha);

      if (registro) {
        registro.ventas = ventas;
        registro.gastos = gastos;
        registro.efectivo = efectivo;
        registro.transferencia = transferencia;
        registro.otros = otros;
        showMessage(`Registro del ${fecha} actualizado con éxito.`, 'success');
      } else {
        registro = { fecha, ventas, gastos, efectivo, transferencia, otros };
        data.registros.push(registro);
        showMessage(`Cierre diario del ${fecha} guardado con éxito.`, 'success');
      }

      saveLocal();
      render();
      clearInputs();
    }

    function guardarFee() {
      const fecha = todayKey();
      const monto = parseFloat($('inputFeeMonto').value) || 0;
      const descripcion = $('inputFeeDescripcion').value.trim();

      if (monto === 0) {
        showMessage('El monto del Fee no puede ser cero.', 'warning');
        return;
      }
      if (descripcion === '') {
        showMessage('La descripción del Fee no puede estar vacía.', 'warning');
        return;
      }

      if (!data.fees[fecha]) {
        data.fees[fecha] = [];
      }

      data.fees[fecha].push({ monto, desc: descripcion, timestamp: Date.now() });
      saveLocal();
      renderTablaFees();
      renderKPIs();
      $('inputFeeMonto').value = '';
      $('inputFeeDescripcion').value = '';
      showMessage(`Fee de ${formatCurrency(monto)} agregado con éxito.`, 'success');

      // Si existe un registro para hoy, actualizar la tabla completa
      if (getRegistro(fecha)) {
        renderTablaCompleto();
      }
    }

    function clearTable() {
      if (confirm('¿Estás seguro de que quieres borrar TODOS los registros? Esta acción es irreversible.')) {
        data.registros = [];
        data.fees = {};
        saveLocal();
        render();
        showMessage('Todos los registros han sido borrados.', 'success');
      }
    }

    function clearFees() {
        const fecha = todayKey();
        if (confirm(`¿Estás seguro de que quieres borrar TODOS los fees registrados para la fecha ${fecha}?`)) {
            delete data.fees[fecha];
            saveLocal();
            renderTablaFees();
            renderKPIs();
            showMessage(`Fees del ${fecha} eliminados.`, 'success');
            if (getRegistro(fecha)) {
                renderTablaCompleto();
            }
        }
    }

    // --- RENDERING ---

    function renderTablaFees() {
      const fecha = todayKey();
      const feesHoy = getFees(fecha);
      const tbody = $('tablaFees').querySelector('tbody');
      tbody.innerHTML = '';

      let total = 0;

      if (feesHoy.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No hay fees registrados para hoy.</td></tr>`;
      } else {
        feesHoy.forEach((fee, index) => {
          total += fee.monto;
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${fee.desc}</td>
            <td class="text-align-right text-warning">-${formatCurrency(fee.monto)}</td>
            <td>
              <button class="acciones-btn btn btn-danger btn-xs" onclick="deleteFee('${fecha}', ${index})" title="Eliminar Fee">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
              </button>
            </td>
          `;
        });
      }
      $('totalFeesHoy').textContent = formatCurrency(total);
    }

    function deleteFee(fecha, index) {
      if (confirm('¿Seguro que quieres eliminar este Fee?')) {
        if (data.fees[fecha] && data.fees[fecha][index]) {
          data.fees[fecha].splice(index, 1);
          if (data.fees[fecha].length === 0) {
            delete data.fees[fecha];
          }
          saveLocal();
          renderTablaFees();
          renderKPIs();
          renderTablaCompleto();
          showMessage('Fee eliminado.', 'success');
        }
      }
    }

    function renderKPIs() {
      const today = todayKey();
      const registroHoy = getRegistro(today);
      const totalFeesHoy = getTotalFees(today);
      const gananciaNetaHoy = calculateNetProfit(registroHoy, totalFeesHoy);
      
      const ventasHoy = registroHoy ? registroHoy.ventas : 0;
      const gastosHoy = registroHoy ? registroHoy.gastos : 0;

      // Cálculo de acumulados (usando la misma lógica de Ingresos/Egresos)
      const totalIngresos = data.registros.reduce((sum, r) => sum + (r.efectivo + r.transferencia + r.otros), 0);
      const totalGastos = data.registros.reduce((sum, r) => sum + r.gastos, 0);
      const totalFeesGeneral = Object.values(data.fees).flat().reduce((sum, fee) => sum + fee.monto, 0);
      const totalEgresos = totalGastos + totalFeesGeneral;
      const totalGananciaNeta = totalIngresos - totalEgresos;

      const kpiData = [
        { title: 'Ventas de Hoy', value: ventasHoy, colorClass: 'text-white' }, // Ventas como dato informativo
        { title: 'Ganancia Neta Hoy', value: gananciaNetaHoy, colorClass: gananciaNetaHoy >= 0 ? 'text-success' : 'text-error' },
        { title: 'Gastos y Fees Hoy', value: gastosHoy + totalFeesHoy, colorClass: 'text-warning' },
        { title: 'Ganancia Neta Total', value: totalGananciaNeta, colorClass: totalGananciaNeta >= 0 ? 'text-success' : 'text-error' },
        { title: 'Total Ingresos (Acumulado)', value: totalIngresos, colorClass: 'text-white' },
      ];

      const html = kpiData.map(kpi => `
        <div class="summary-card">
          <div class="summary-title">${kpi.title}</div>
          <div class="summary-value ${kpi.colorClass}">${formatCurrency(kpi.value)}</div>
        </div>
      `).join('');

      $('kpiContainer').innerHTML = html;
    }

    function renderTablaCompleto() {
      // 1. Obtener y aplicar filtros
      const filterDia = $('filterDia').value;
      const filterMes = $('filterMes').value;
      const filterAnio = $('filterAnio').value;

      let filteredRegistros = data.registros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      if (filterDia) {
        // Asegúrate de que el filtro de día sea '01', '02', etc.
        filteredRegistros = filteredRegistros.filter(r => r.fecha.substring(8, 10) === filterDia.padStart(2, '0'));
      }
      if (filterMes) {
        // Asegúrate de que el filtro de mes sea '01', '02', etc.
        filteredRegistros = filteredRegistros.filter(r => r.fecha.substring(5, 7) === filterMes.padStart(2, '0'));
      }
      if (filterAnio) {
        filteredRegistros = filteredRegistros.filter(r => r.fecha.substring(0, 4) === filterAnio);
      }

      const tbody = $('registrosCompletosBody');
      tbody.innerHTML = '';

      let totalVentas = 0, totalGastos = 0, totalEfectivo = 0, totalTransferencia = 0, totalOtros = 0, totalFees = 0, totalGananciaNeta = 0;

      if (filteredRegistros.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No hay registros que coincidan con los filtros.</td></tr>`;
      } else {
        filteredRegistros.forEach(registro => {
          const feesDia = getTotalFees(registro.fecha);
          const gananciaNeta = calculateNetProfit(registro, feesDia);

          totalVentas += registro.ventas;
          totalGastos += registro.gastos;
          totalEfectivo += registro.efectivo;
          totalTransferencia += registro.transferencia;
          totalOtros += registro.otros;
          totalFees += feesDia;
          totalGananciaNeta += gananciaNeta;

          const date = new Date(registro.fecha + 'T00:00:00'); // Añadir T00:00:00 para evitar problemas de zona horaria
          const formattedDate = date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });

          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${formattedDate}</td>
            <td class="text-align-right">${formatCurrency(registro.ventas)}</td>
            <td class="text-align-right">${formatCurrency(registro.gastos)}</td>
            <td class="text-align-right">${formatCurrency(registro.efectivo)}</td>
            <td class="text-align-right">${formatCurrency(registro.transferencia)}</td>
            <td class="text-align-right">${formatCurrency(registro.otros)}</td>
            <td class="text-align-right text-warning">-${formatCurrency(feesDia)}</td>
            <td class="text-align-right ${gananciaNeta >= 0 ? 'text-success' : 'text-error'}">${formatCurrency(gananciaNeta)}</td>
            <td>
              <button class="acciones-btn btn btn-secondary btn-xs" onclick="loadRegistroForEditing('${registro.fecha}')" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-4.606 5.567L12.16 10.43l-4.243 4.243-4.243-4.243 4.243-4.243zM4 17h12v2H4z" /></svg>
              </button>
              <button class="acciones-btn btn btn-danger btn-xs" onclick="deleteRegistro('${registro.fecha}')" title="Eliminar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
              </button>
            </td>
          `;
        });

        // Fila de totales
        const footerRow = tbody.insertRow();
        footerRow.classList.add('font-bold', 'border-t-2', 'border-accent');
        footerRow.innerHTML = `
            <td>TOTALES</td>
            <td class="text-align-right">${formatCurrency(totalVentas)}</td>
            <td class="text-align-right">${formatCurrency(totalGastos)}</td>
            <td class="text-align-right">${formatCurrency(totalEfectivo)}</td>
            <td class="text-align-right">${formatCurrency(totalTransferencia)}</td>
            <td class="text-align-right">${formatCurrency(totalOtros)}</td>
            <td class="text-align-right text-warning">-${formatCurrency(totalFees)}</td>
            <td class="text-align-right ${totalGananciaNeta >= 0 ? 'text-success' : 'text-error'}">${formatCurrency(totalGananciaNeta)}</td>
            <td></td>
        `;
      }
      
      // 2. Rellenar opciones de filtro
      populateFilterOptions();
    }

    function populateFilterOptions() {
      const allDates = data.registros.map(r => r.fecha).sort();
      const years = new Set(allDates.map(d => d.substring(0, 4)));
      const months = new Set(allDates.map(d => d.substring(5, 7)));
      const days = new Set(allDates.map(d => d.substring(8, 10)));

      // Helper para poblar select
      const populateSelect = (id, values) => {
        const select = $(id);
        const selectedValue = select.value;
        select.innerHTML = `<option value="">${id === 'filterDia' ? 'Todos los Días' : id === 'filterMes' ? 'Todos los Meses' : 'Todos los Años'}</option>`;
        values.forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val;
          if (id === 'filterMes') {
            const date = new Date(null, parseInt(val) - 1, 1);
            option.textContent = date.toLocaleDateString('es-ES', { month: 'long' });
          }
          if (val === selectedValue) option.selected = true;
          select.appendChild(option);
        });
      };

      populateSelect('filterAnio', Array.from(years).sort((a, b) => b - a));
      populateSelect('filterMes', Array.from(months).sort((a, b) => b - a));
      populateSelect('filterDia', Array.from(days).sort((a, b) => b - a));
    }

    function clearFilters() {
      $('filterDia').value = '';
      $('filterMes').value = '';
      $('filterAnio').value = '';
      renderTablaCompleto();
    }

    function loadRegistroForEditing(fecha) {
      const registro = getRegistro(fecha);
      if (registro) {
        $('inputFecha').value = registro.fecha;
        $('inputVentas').value = registro.ventas;
        $('inputGastos').value = registro.gastos;
        $('inputEfectivo').value = registro.efectivo;
        $('inputTransferencia').value = registro.transferencia;
        $('inputOtros').value = registro.otros;
        showMessage(`Cargado registro del ${fecha} para editar.`, 'success');
        // Asegúrate de que los inputs de Fees estén limpios si se está editando un día anterior
        if (fecha !== todayKey()) {
            $('inputFeeMonto').value = '';
            $('inputFeeDescripcion').value = '';
            renderTablaFees(); // Renderiza los fees del día actual (que serán cero si no hay)
        }
      }
    }

    function deleteRegistro(fecha) {
      if (confirm(`¿Estás seguro de que quieres borrar el registro diario y todos los Fees asociados para la fecha ${fecha}?`)) {
        data.registros = data.registros.filter(r => r.fecha !== fecha);
        delete data.fees[fecha];
        saveLocal();
        render();
        showMessage(`Registro del ${fecha} eliminado.`, 'success');
      }
    }

    // --- IMPORT / EXPORT (JSON) ---
    function exportJSON() {
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `caja_diaria_backup_${todayKey()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showMessage('Datos exportados como JSON.', 'success');
    }

    function importJSON() {
      // Activa el input de tipo file oculto
      $('fileInput').click();
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedData = JSON.parse(e.target.result);
          if (importedData && Array.isArray(importedData.registros)) {
            if (confirm('¿Deseas reemplazar todos los datos locales con el archivo importado?')) {
              data = importedData;
              // Asegurar que fees sea un objeto si falta
              if (typeof data.fees !== 'object' || data.fees === null) {
                data.fees = {};
              }
              saveLocal();
              render();
              showMessage('Datos importados con éxito.', 'success');
            }
          } else {
            showMessage('El archivo JSON no parece ser un backup de Caja Diaria válido.', 'error');
          }
        } catch (error) {
          showMessage('Error al procesar el archivo: formato JSON inválido.', 'error');
          console.error('Import error:', error);
        }
      };
      reader.readAsText(file);
      // Limpiar el valor del input file para poder importar el mismo archivo de nuevo
      event.target.value = null;
    }

    // --- MESSAGE / MODAL UI ---
    function showMessage(message, type = 'info') {
      // Usaremos el modal para mostrar mensajes de estado de Google Drive
      if ($('cloudModal').classList.contains('show')) {
          const cloudMessage = $('cloudMessage');
          cloudMessage.textContent = message;
          cloudMessage.className = 'mb-6 text-center'; // Reset class

          if (type === 'success') {
              cloudMessage.classList.add('text-success');
          } else if (type === 'error') {
              cloudMessage.classList.add('text-error');
          } else if (type === 'warning') {
              cloudMessage.classList.add('text-warning');
          } else {
              cloudMessage.classList.add('text-muted');
          }

          // Cerrar modal automáticamente después de un éxito si no es una carga en curso
          if (type === 'success' && !driveUploadInProgress) {
              driveTimeout = setTimeout(closeModal, 2000);
          }
      } else {
         // Fallback simple para la consola
         console.log(`[${type.toUpperCase()}] ${message}`);
      }
    }

    function openModal() {
      // Limpiar cualquier timeout anterior
      if (driveTimeout) {
        clearTimeout(driveTimeout);
        driveTimeout = null;
      }

      $('cloudTitle').textContent = 'Conexión a Google Drive';
      $('driveControls').classList.add('hidden');
      $('btnAuthorizeDrive').classList.add('hidden');
      $('btnUploadDrive').classList.add('hidden');
      $('btnDownloadDrive').classList.add('hidden');

      // Mostrar modal
      $('cloudModal').classList.add('show');
      $('cloudMessage').textContent = 'Iniciando servicios de Google...';
      
      // 0. VERIFICACIÓN CRÍTICA DEL CLIENT ID
      if (CLIENT_ID === 'TU_CLIENT_ID_DE_GOOGLE_AQUI') {
          showMessage('ERROR: Por favor, reemplaza "TU_CLIENT_ID_DE_GOOGLE_AQUI" con tu CLIENT ID real.', 'error');
          return;
      }

      // ** FIX CORE: Usar un intervalo para esperar hasta que los scripts estén cargados **
      const initInterval = setInterval(() => {
          // Check if both global objects are available AND we haven't started initialization yet
          if (typeof gapi !== 'undefined' && typeof google !== 'undefined' && !googleServicesReady) {
              clearInterval(initInterval);
              initializeGoogleServices();
          } else if (googleServicesReady) {
              // Si ya se inicializó, simplemente actualiza el estado (ej. si el usuario cerró y reabrió el modal)
              clearInterval(initInterval);
              checkDriveAuthStatus();
          }
      }, 300); // Revisa cada 300ms
    }
    
    function closeModal() {
      // Limpiar timeout si existe
      if (driveTimeout) {
        clearTimeout(driveTimeout);
        driveTimeout = null;
      }
      driveUploadInProgress = false;
      $('cloudModal').classList.remove('show'); 
    }

    // --- GOOGLE DRIVE INTEGRATION (Auth and File Management) ---
    
    // 1. Inicia el proceso de carga de GAPI y GIS
    function initializeGoogleServices() {
        if (googleServicesReady) return; // Ya inicializado

        // 1. Inicializa GAPI client
        gapi.load('client', () => {
            gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
            }).then(() => {
                gapiInitialized = true;
                // 2. Inicializa GIS (Identity Services)
                initializeGoogleIdentityServices();
            }, (error) => {
                // Esto ocurre si el CLIENT_ID es incorrecto o si hay un error de red/política.
                showMessage('Error al inicializar la API de Google Drive. Revisa tu CLIENT ID y la consola.', 'error');
                console.error('GAPI Client Init Error:', error);
            });
        });
    }

    // 2. Inicializa GIS (Identity Services)
    function initializeGoogleIdentityServices() {
        if (gisReady || typeof google === 'undefined') return;

        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    gapi.client.setToken({ access_token: tokenResponse.access_token });
                    // Si el modal está abierto, actualiza el estado
                    if ($('cloudModal').classList.contains('show')) {
                        checkDriveAuthStatus(true);
                    }
                }
            },
        });
        gisReady = true;
        googleServicesReady = true; // Todo listo

        // Una vez que ambos están listos, verifica el estado de la autenticación
        checkDriveAuthStatus();
    }

    // 3. Manejar el click de Autorizar
    function handleAuthClick() {
      if (!tokenClient) {
        showMessage('Error: Servicios de Google no inicializados correctamente.', 'error');
        return;
      }
      
      // Llamar a la función para solicitar el token
      tokenClient.requestAccessToken({prompt: 'consent'});
    }

    // 4. Verificar estado de la autorización
    function checkDriveAuthStatus(isNewAuth = false) {
        if (!googleServicesReady) {
             showMessage('Esperando inicialización de servicios de Google...', 'warning');
             return;
        }

        const token = gapi.client.getToken();
        // Simple check: if a token exists and we are past initialization
        const isAuthenticated = token !== null && token?.access_token; 
        
        $('driveControls').classList.remove('hidden');

        if (isAuthenticated) {
            $('cloudMessage').textContent = isNewAuth 
                ? '¡Autorización exitosa! Listo para subir y descargar.'
                : 'Conectado a Google Drive.';
            $('btnAuthorizeDrive').classList.add('hidden');
            $('btnUploadDrive').classList.remove('hidden');
            $('btnDownloadDrive').classList.remove('hidden');
            $('btnUploadDrive').onclick = uploadToDrive;
            $('btnDownloadDrive').onclick = downloadFromDrive;
        } else {
            $('cloudMessage').textContent = 'Necesitas autorizar la aplicación para acceder a Google Drive.';
            $('btnAuthorizeDrive').classList.remove('hidden');
            $('btnUploadDrive').classList.add('hidden');
            $('btnDownloadDrive').classList.add('hidden');
            $('btnAuthorizeDrive').onclick = handleAuthClick;
            
            // FIX: Si no está autenticado y la ventana está abierta, pide autorización inmediatamente
            if ($('cloudModal').classList.contains('show')) {
                handleAuthClick();
            }
        }
    }

    // 5. Gestionar archivos
    let driveFileId = null;
    const DRIVE_FILE_NAME = 'caja_diaria_control.json';

    async function ensureDriveFileExists() {
        if (driveFileId) return driveFileId;

        showMessage('Buscando archivo en Google Drive...', 'info');

        try {
            const response = await gapi.client.drive.files.list({
                q: `name = '${DRIVE_FILE_NAME}' and trashed = false`,
                spaces: 'drive',
                fields: 'files(id)',
            });

            if (response.result.files.length > 0) {
                driveFileId = response.result.files[0].id;
                showMessage(`Archivo encontrado (ID: ${driveFileId}).`, 'info');
                return driveFileId;
            } else {
                showMessage('Archivo no encontrado. Se creará uno nuevo al subir.', 'warning');
                return null;
            }
        } catch (error) {
            showMessage('Error al buscar el archivo en Drive. Revisa la consola.', 'error');
            return null;
        }
    }

    async function uploadToDrive() {
        if (!gapi.client.getToken()?.access_token) {
            showMessage('Por favor, autoriza primero la conexión con Google Drive.', 'warning');
            handleAuthClick(); // Solicitar autorización si no está
            return;
        }
        
        driveUploadInProgress = true;
        showMessage('Preparando datos para subir...', 'info');

        const fileId = await ensureDriveFileExists();
        const dataToUpload = JSON.stringify(data, null, 2);
        const metadata = {
            'name': DRIVE_FILE_NAME,
            'mimeType': 'application/json',
        };

        const boundary = 'foo_bar_baz';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delimiter = "\r\n--" + boundary + "--";

        const multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            dataToUpload +
            close_delimiter;

        const request = gapi.client.request({
            'path': '/upload/drive/v3/files/' + (fileId ? fileId : ''),
            'method': fileId ? 'PATCH' : 'POST',
            'params': {
                'uploadType': 'multipart',
                'fileId': fileId,
                'addParents': fileId ? undefined : 'root', // Si es nuevo, añadir a la raíz
            },
            'headers': {
                'Content-Type': 'multipart/mixed; boundary="' + boundary + '"',
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
            },
            'body': multipartRequestBody
        });

        try {
            const response = await request;
            driveFileId = response.result.id; // Actualizar ID en caso de ser nuevo
            showMessage('¡Datos subidos y guardados en Google Drive con éxito!', 'success');
            driveUploadInProgress = false;
        } catch (error) {
            showMessage('Error al subir el archivo a Drive. Revisa la consola.', 'error');
            console.error('Drive Upload Error:', error);
            driveUploadInProgress = false;
        }
    }

    async function downloadFromDrive() {
        if (!gapi.client.getToken()?.access_token) {
            showMessage('Por favor, autoriza primero la conexión con Google Drive.', 'warning');
            handleAuthClick();
            return;
        }
        
        const fileId = await ensureDriveFileExists();
        if (!fileId) {
            showMessage('No se encontró ningún archivo de Caja Diaria en Drive para descargar.', 'warning');
            return;
        }
        
        if (!confirm('¿Seguro que quieres descargar los datos de Drive? ¡Esto SOBRESCRIBIRÁ todos tus datos locales!')) {
            return;
        }

        showMessage('Descargando datos de Google Drive...', 'info');

        try {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media' // Parámetro crucial para obtener el contenido del archivo
            });

            const downloadedData = response.result;
            
            if (downloadedData && Array.isArray(downloadedData.registros)) {
                data = downloadedData;
                // Asegurar que fees sea un objeto si falta
                if (typeof data.fees !== 'object' || data.fees === null) {
                    data.fees = {};
                }
                saveLocal();
                render();
                showMessage('¡Datos descargados de Google Drive y cargados localmente con éxito!', 'success');
            } else {
                showMessage('El archivo descargado no parece ser un backup de Caja Diaria válido.', 'error');
            }

        } catch (error) {
            showMessage('Error al descargar el archivo de Drive. Revisa la consola.', 'error');
        }
    }


    // --- INICIALIZACIÓN ---
    function render() {
      // Poner la fecha actual por defecto si no hay nada en el input
      if (!$('inputFecha').value) {
        $('inputFecha').value = todayKey();
      }

      renderKPIs();
      renderTablaFees();
      renderTablaCompleto();
    }

    function init() {
      // 1. Cargar datos locales
      loadLocal();
      
      // 2. Renderizar UI inicial
      render();

      // 3. Establecer Listeners
      $('btnGuardar').addEventListener('click', guardarCierreDiario);
      $('btnGuardarFee').addEventListener('click', guardarFee); // Listener para Fees
      $('btnExport').addEventListener('click', exportJSON);
      $('btnImport').addEventListener('click', importJSON);
      $('btnSaveCloud').addEventListener('click', openModal);
      $('fileInput').addEventListener('change', handleFileSelect);
      $('btnClear').addEventListener('click', clearTable);
      $('btnClearFees').addEventListener('click', clearFees);
      
      // Listeners para filtros
      $('filterDia').addEventListener('change', renderTablaCompleto);
      $('filterMes').addEventListener('change', renderTablaCompleto);
      $('filterAnio').addEventListener('change', renderTablaCompleto);
      $('btnClearFilters').addEventListener('click', clearFilters);
    }

    // Iniciar la aplicación
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
